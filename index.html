<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR Human Figure</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #webxr-button {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1000;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            max-width: 300px;
            z-index: 1000;
        }
        
        #status {
            margin-top: 10px;
            font-size: 14px;
            color: #ccc;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="container">
        <button id="webxr-button">Enter VR</button>
        <div id="info-panel">
            <h3>WebXR Human Figure</h3>
            <p>Controls:</p>
            <ul>
                <li>Move: VR Controllers</li>
                <li>Rotate: Right Stick/Grip</li>
                <li>Reset: Press 'R' key</li>
            </ul>
            <div id="status">Initializing WebXR...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/controls/VRControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/effects/VREffect.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/webxr/VRButton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/webxr/XRControllerModelFactory.js"></script>

    <script>
        // Main WebXR application
        class WebXRHumanFigure {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.humanFigure = null;
                this.controllers = [];
                this.raycaster = new THREE.Raycaster();
                this.selectedPart = null;
                
                this.init();
            }
            
            init() {
                // Create scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000);
                
                // Create camera
                this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
                this.camera.position.set(0, 1.6, 3);
                
                // Create renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                document.getElementById('container').appendChild(this.renderer.domElement);
                
                // Add VR button
                document.getElementById('webxr-button').appendChild(VRButton.createButton(this.renderer));
                
                // Setup lighting
                this.setupLighting();
                
                // Create human figure
                this.createHumanFigure();
                
                // Setup controllers
                this.setupControllers();
                
                // Add event listeners
                this.setupEventListeners();
                
                // Start animation loop
                this.renderer.setAnimationLoop(() => this.animate());
                
                document.getElementById('status').textContent = 'Ready - Click Enter VR to start';
            }
            
            setupLighting() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                // Directional light
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(5, 5, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                // Point light
                const pointLight = new THREE.PointLight(0x4444ff, 0.8, 10);
                pointLight.position.set(2, 3, 2);
                this.scene.add(pointLight);
            }
            
            createHumanFigure() {
                this.humanFigure = new THREE.Group();
                this.humanFigure.position.y = 1;
                
                // Body parts with different colors and materials
                const parts = {
                    head: { size: [0.3, 0.3, 0.3], position: [0, 1.7, 0], color: 0xF5D0A9 },
                    torso: { size: [0.6, 0.8, 0.3], position: [0, 1.0, 0], color: 0x58ACFA },
                    leftArm: { size: [0.15, 0.6, 0.15], position: [-0.4, 1.2, 0], color: 0xF5D0A9 },
                    rightArm: { size: [0.15, 0.6, 0.15], position: [0.4, 1.2, 0], color: 0xF5D0A9 },
                    leftLeg: { size: [0.2, 0.7, 0.2], position: [-0.2, 0.3, 0], color: 0x2E64FE },
                    rightLeg: { size: [0.2, 0.7, 0.2], position: [0.2, 0.3, 0], color: 0x2E64FE }
                };
                
                // Create each body part
                for (const [partName, config] of Object.entries(parts)) {
                    const geometry = new THREE.BoxGeometry(...config.size);
                    const material = new THREE.MeshPhongMaterial({ 
                        color: config.color,
                        shininess: 30,
                        transparent: true,
                        opacity: 0.9
                    });
                    
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(...config.position);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    mesh.userData = { partName: partName, isBodyPart: true };
                    
                    // Add wireframe for better visibility
                    const wireframe = new THREE.LineSegments(
                        new THREE.EdgesGeometry(geometry),
                        new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 })
                    );
                    mesh.add(wireframe);
                    
                    this.humanFigure.add(mesh);
                }
                
                // Add joints
                this.addJoints();
                
                this.scene.add(this.humanFigure);
            }
            
            addJoints() {
                const jointPositions = [
                    [0, 1.4, 0],    // Neck
                    [-0.4, 0.8, 0], // Left shoulder
                    [0.4, 0.8, 0],  // Right shoulder
                    [-0.2, 0.8, 0], // Left hip
                    [0.2, 0.8, 0],  // Right hip
                    [-0.2, -0.2, 0], // Left knee
                    [0.2, -0.2, 0]   // Right knee
                ];
                
                jointPositions.forEach((position, index) => {
                    const geometry = new THREE.SphereGeometry(0.08, 8, 8);
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0xFF0000,
                        emissive: 0x330000
                    });
                    
                    const joint = new THREE.Mesh(geometry, material);
                    joint.position.set(...position);
                    this.humanFigure.add(joint);
                });
            }
            
            setupControllers() {
                const controllerModelFactory = new THREE.XRControllerModelFactory();
                
                // Left controller
                const leftController = this.renderer.xr.getController(0);
                leftController.addEventListener('selectstart', () => this.onSelectStart(0));
                leftController.addEventListener('selectend', () => this.onSelectEnd(0));
                this.scene.add(leftController);
                
                const leftGrip = this.renderer.xr.getControllerGrip(0);
                leftGrip.add(controllerModelFactory.createControllerModel(leftGrip));
                this.scene.add(leftGrip);
                
                // Right controller
                const rightController = this.renderer.xr.getController(1);
                rightController.addEventListener('selectstart', () => this.onSelectStart(1));
                rightController.addEventListener('selectend', () => this.onSelectEnd(1));
                this.scene.add(rightController);
                
                const rightGrip = this.renderer.xr.getControllerGrip(1);
                rightGrip.add(controllerModelFactory.createControllerModel(rightGrip));
                this.scene.add(rightGrip);
                
                this.controllers = [leftController, rightController];
                
                // Add controller rays
                this.controllers.forEach(controller => {
                    const geometry = new THREE.BufferGeometry();
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));
                    geometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));
                    
                    const material = new THREE.LineBasicMaterial({ 
                        vertexColors: true, 
                        blending: THREE.AdditiveBlending 
                    });
                    
                    const ray = new THREE.Line(geometry, material);
                    ray.scale.z = 5;
                    controller.add(ray);
                });
            }
            
            onSelectStart(controllerIndex) {
                const controller = this.controllers[controllerIndex];
                this.raycaster.setFromXRController(controller);
                
                const intersects = this.raycaster.intersectObjects(this.humanFigure.children, true);
                
                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    if (object.userData.isBodyPart) {
                        this.selectedPart = {
                            object: object,
                            controller: controller,
                            offset: new THREE.Vector3().subVectors(object.position, controller.position)
                        };
                        
                        // Highlight selected part
                        object.material.emissive.setHex(0x333300);
                        object.material.needsUpdate = true;
                    }
                }
            }
            
            onSelectEnd(controllerIndex) {
                if (this.selectedPart && this.selectedPart.controller === this.controllers[controllerIndex]) {
                    // Remove highlight
                    this.selectedPart.object.material.emissive.setHex(0x000000);
                    this.selectedPart.object.material.needsUpdate = true;
                    this.selectedPart = null;
                }
            }
            
            setupEventListeners() {
                window.addEventListener('resize', () => this.onWindowResize());
                
                // Keyboard controls
                document.addEventListener('keydown', (event) => {
                    switch(event.key.toLowerCase()) {
                        case 'r':
                            this.resetHumanFigure();
                            break;
                        case ' ':
                            this.animateFigure();
                            break;
                    }
                });
            }
            
            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            resetHumanFigure() {
                this.humanFigure.rotation.set(0, 0, 0);
                this.humanFigure.position.set(0, 1, 0);
            }
            
            animateFigure() {
                // Simple animation cycle
                const parts = this.humanFigure.children.filter(child => child.userData.isBodyPart);
                
                parts.forEach((part, index) => {
                    const originalY = part.position.y;
                    
                    // Animate up and down
                    new TWEEN.Tween(part.position)
                        .to({ y: originalY + 0.1 }, 200)
                        .easing(TWEEN.Easing.Quadratic.InOut)
                        .yoyo(true)
                        .repeat(1)
                        .delay(index * 100)
                        .start();
                });
            }
            
            animate() {
                // Update selected part position if dragging
                if (this.selectedPart) {
                    const controller = this.selectedPart.controller;
                    this.selectedPart.object.position.copy(controller.position).add(this.selectedPart.offset);
                }
                
                // Rotate human figure slowly
                if (!this.selectedPart) {
                    this.humanFigure.rotation.y += 0.005;
                }
                
                // Update TWEEN animations
                TWEEN.update();
                
                // Render scene
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // Initialize the application when the page loads
        window.addEventListener('load', () => {
            new WebXRHumanFigure();
        });
        
        // Add TWEEN.js for animations
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
